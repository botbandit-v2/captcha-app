<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Проверка CAPTCHA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100vw;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0;
      box-sizing: border-box;
      background-color: var(--bg-color, #ffffff);
      transition: background-color 0.3s ease;
    }
    .captcha-wrapper {
      width: 100%;
      max-width: 360px;
      padding: 0 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow-x: hidden;
    }
    .version-watermark {
      margin-top: 16px;
      text-align: center;
      font-size: 10px;
      color: rgba(128, 128, 128, 0.5);
      font-family: monospace;
      pointer-events: none;
    }
    .status-indicator {
      margin-top: 12px;
      padding: 8px 12px;
      text-align: center;
      font-size: 12px;
      border-radius: 6px;
      font-family: system-ui, -apple-system, sans-serif;
      min-height: 16px;
      transition: all 0.3s ease;
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
    }
    .status-loading {
      background: rgba(0, 123, 255, 0.1);
      color: #007bff;
      border: 1px solid rgba(0, 123, 255, 0.3);
    }
    .status-success {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.3);
    }
    .status-error {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.3);
      border-radius: 6px;
      white-space: pre-wrap;
      text-align: left;
      font-family: monospace;
      font-size: 11px;
      max-width: 100%;
      width: 100vw;
      box-sizing: border-box;
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      margin-left: calc(-50vw + 50%);
      margin-right: calc(-50vw + 50%);
      padding: 8px 4px;
      max-height: 60vh;
      overflow-y: auto;
      position: relative;
      z-index: 9999;
    }
    .copy-button {
      background: #dc3545;
      color: white;
      border: 1px solid rgba(220, 53, 69, 0.3);
      border-radius: 6px;
      padding: 12px;
      font-size: 12px;
      cursor: pointer;
      font-family: system-ui, -apple-system, sans-serif;
      transition: background-color 0.2s ease;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin-top: 8px;
      margin-bottom: 0;
      text-align: center;
      font-weight: 500;
      display: block;
      outline: none;
    }
    .copy-button:hover {
      background: #c82333 !important;
    }
    .copy-button:active {
      background: #bd2130 !important;
    }
    .copy-button.copied {
      background: #28a745 !important;
    }
    .status-hidden {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="captcha-wrapper">
    <div id="captcha-container"></div>
    <div id="status-indicator" class="status-indicator status-hidden"></div>
    <button id="copy-button" class="copy-button status-hidden">копировать ошибку</button>
    <div class="version-watermark">v1.0.10a</div>
  </div>

  <script>
    let platform = 'unknown';
    let rawData = '';
    let theme = 'light';

    function showStatus(type, message) {
      const indicator = document.getElementById('status-indicator');
      const copyButton = document.getElementById('copy-button');
      
      indicator.className = `status-indicator status-${type}`;
      indicator.textContent = message;
      
      if (type === 'error') {
        // показываем кнопку копирования
        copyButton.className = 'copy-button';
        copyButton.onclick = () => copyErrorText(message, copyButton);
      } else {
        // скрываем кнопку копирования
        copyButton.className = 'copy-button status-hidden';
      }
    }

    function hideStatus() {
      const indicator = document.getElementById('status-indicator');
      const copyButton = document.getElementById('copy-button');
      
      indicator.className = 'status-indicator status-hidden';
      copyButton.className = 'copy-button status-hidden';
    }

    async function copyErrorText(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        const originalText = button.textContent;
        button.textContent = 'скопировано!';
        button.classList.add('copied');
        
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (err) {
        // фолбэк для старых браузеров
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          document.execCommand('copy');
          button.textContent = 'скопировано!';
          button.classList.add('copied');
          
          setTimeout(() => {
            button.textContent = 'копировать';
            button.classList.remove('copied');
          }, 2000);
        } catch (err2) {
          button.textContent = 'ошибка';
          setTimeout(() => {
            button.textContent = 'копировать';
          }, 2000);
        }
        
        document.body.removeChild(textArea);
      }
    }

    const isTelegram = window.Telegram?.WebApp?.initData;
    const isVK = !isTelegram;

    function applyTheme(theme) {
      document.body.style.setProperty('--bg-color', theme === 'dark' ? '#000000' : '#ffffff');
      if (platform === 'vk' && window.hcaptcha) {
        const captcha = document.querySelector('.h-captcha');
        if (captcha) captcha.setAttribute('data-theme', theme);
      }
    }

    function insertTelegramCaptcha() {
      const container = document.getElementById('captcha-container');
      container.innerHTML = `<div id="recaptcha-el"></div>`;

      const existingScript = document.querySelector('script[src*="recaptcha"]');
      if (existingScript) existingScript.remove();

      const script = document.createElement('script');
      script.src = 'https://www.google.com/recaptcha/api.js?onload=onRecaptchaLoaded&render=explicit';
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    function onRecaptchaLoaded() {
      grecaptcha.render('recaptcha-el', {
        sitekey: '6LerHJUrAAAAAOBToNOvkY4Qtf09c4202uM8xLDW',
        callback: onCaptchaSuccess,
        theme: theme
      });
    }

    function insertVKCaptcha() {
      const container = document.getElementById('captcha-container');
      container.innerHTML = `
        <div class="h-captcha" 
             data-sitekey="5ae63666-6d46-47b0-ad48-a96829a83a7a" 
             data-callback="onCaptchaSuccess" 
             data-theme="${theme}">
        </div>`;

      const existingScript = document.querySelector('script[src*="hcaptcha"]');
      if (existingScript) existingScript.remove();

      const script = document.createElement('script');
      script.src = 'https://hcaptcha.com/1/api.js?hl=ru&onload=hcaptchaLoaded';
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    }

    function hcaptchaLoaded() {
      const container = document.querySelector('.h-captcha');
      if (container && window.hcaptcha) {
        window.hcaptcha.render(container);
      }
    }

    if (isTelegram) {
      const tg = window.Telegram.WebApp;
      platform = 'tg';
      rawData = encodeURIComponent(JSON.stringify(tg.initDataUnsafe));
      theme = tg.colorScheme;
      tg.ready();

      tg.onEvent('themeChanged', () => {
        theme = tg.colorScheme;
        applyTheme(theme);
        insertTelegramCaptcha();
      });

      applyTheme(theme);
      insertTelegramCaptcha();

    } else if (isVK) {
      platform = 'vk';

      (async () => {
        try {
          await vkBridge.send('VKWebAppInit');
          const launchParams = await vkBridge.send('VKWebAppGetLaunchParams');
          rawData = encodeURIComponent(JSON.stringify(launchParams));

          const config = await vkBridge.send('VKWebAppGetConfig');
          theme = config.scheme?.includes('dark') ? 'dark' : 'light';
          applyTheme(theme);

          vkBridge.subscribe(e => {
            if (e.detail.type === 'VKWebAppUpdateConfig') {
              const newScheme = e.detail.data.scheme || 'bright_light';
              const newTheme = newScheme.includes('dark') ? 'dark' : 'light';
              theme = newTheme;
              applyTheme(theme);
              insertVKCaptcha();
            }
          });

          insertVKCaptcha();
        } catch (err) {
          console.error('[VK] Ошибка инициализации:', err);
          document.body.innerHTML += '<pre style="color: red">VK init failed:\n' + err.toString() + '</pre>';
          alert('VK Mini App не смог загрузиться. Проверь подключение и запусти через VK.');
        }
      })();
    }

    async function onCaptchaSuccess(token) {
      showStatus('loading', 'проверяем капчу...');
      
      const encodedToken = encodeURIComponent(token);
      const url = `https://bstatic.botbandit.com/captcha.php?captcha=${encodedToken}&rawData=${rawData}&platform=${platform}`;

      try {
        showStatus('loading', 'загрузка...');
        
        // добавляем контроллер для отмены запроса и таймаут
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          showStatus('error', 'превышено время ожидания ответа от сервера (30 сек)');
        }, 30000);

        const res = await fetch(url, {
          signal: controller.signal,
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Cache-Control': 'no-cache'
          }
        });

        clearTimeout(timeoutId);
        showStatus('loading', 'обработка...');
        
        let data;
        try {
          data = await res.clone().json();
        } catch (err) {
          data = { success: false, error: await res.text() };
        }

        if (data.success) {
          showStatus('success', 'проверка пройдена! приложение закрывается...');
          
          setTimeout(() => {
            if (platform === 'tg') {
              window.Telegram.WebApp.sendData('verified');
              setTimeout(() => {
                window.Telegram.WebApp.close();
              }, 100);
            } else if (platform === 'vk') {
              vkBridge.send('VKWebAppClose', { status: 'success' });
            }
          }, 1000);
        } else {
          throw new Error(typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data));
        }
      } catch (e) {
        if (e.name === 'AbortError') {
          // таймаут уже обработан выше
          return;
        }
        
        showStatus('error', `ошибка: ${e.message}\n\nплатформа: ${platform}\nurl: ${url}`);

        if (window.hcaptcha && platform === 'vk') window.hcaptcha.reset();
      }
    }
  </script>
</body>
</html>
